<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ç£å¥½è¡Œé‡‘é–€ï½œæ’è¡Œæ¦œ</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      font-family: system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Arial;
      --bg:#0b0c10; --card:#141622; --line:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.78); --soft:rgba(255,255,255,.06);
      --pri:#7aa2ff; --good:#35d07f; --warn:#ffb86b;
    }
    body{margin:0;background:var(--bg);color:#fff}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 10px 28px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;opacity:.95}
    h1{font-size:22px;margin:6px 0 0}
    h2{font-size:16px;margin:0}
    .sub{opacity:.86;font-size:13px;line-height:1.6;margin-top:8px}
    .tiny{font-size:12px;opacity:.86;line-height:1.6}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.12);
      background:#1d2140;color:#fff;border-radius:14px;
      padding:10px 12px;font-weight:900;cursor:pointer
    }
    .btn.secondary{background:transparent}
    .btn.good{background:#1f3d2c}
    .btn.warn{background:#40211d}
    input,select{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.15);background:#0f1120;color:#fff;font-size:16px
    }
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;text-align:left}
    th{font-size:12px;opacity:.8}
    td{font-size:14px}
    .rank{font-weight:1000}
    .goodTxt{color:var(--good)}
    .warnTxt{color:var(--warn)}
    .right{text-align:right}
    .muted{opacity:.75}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}
    @media (max-width:860px){.grid2{grid-template-columns:1fr}}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:16px;background:rgba(20,22,34,.95);
      border:1px solid rgba(255,255,255,.12);border-radius:14px;
      padding:10px 12px;max-width:92vw;display:none
    }
    .k{display:inline-block;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:2px 8px;font-size:12px;opacity:.9}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <div class="row">
        <div>
          <div class="pill">ğŸ† å°ç£å¥½è¡Œé‡‘é–€ï½œæ’è¡Œæ¦œ</div>
          <h1>ç©éŠæˆ²æ­å¥½è¡Œï½œæˆç¸¾æ¦œï¼ˆæœ¬æ©Ÿç¤ºç¯„ï¼‰</h1>
          <div class="sub">
            é€™ç‰ˆæ˜¯ <b>ç´”å‰ç«¯</b> çš„ç¤ºç¯„æ’è¡Œæ¦œï¼šæœƒæŠŠç©å®¶æˆç¸¾å­˜åˆ°ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚<br/>
            ä¹‹å¾Œè‹¥è¦ã€Œå…¨é«”å…±ç”¨ã€æ’è¡Œæ¦œï¼Œå¯ä»¥å†æ”¹æˆ Google Sheet / Firebase / å¾Œç«¯ APIã€‚
          </div>
        </div>
        <div class="row" style="justify-content:flex-start">
          <button class="btn secondary" id="backBtn">â¬… å› TM é¦–é </button>
          <button class="btn secondary" id="copyLinkBtn">ğŸ”— è¤‡è£½æœ¬é é€£çµ</button>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="card" style="margin:0">
        <h2>â‘  è®€å–æˆç¸¾ï¼ˆå¾éŠæˆ²è·³è½‰å¸¶å…¥ï¼‰</h2>
        <div class="tiny muted" style="margin-top:8px">
          è‹¥ä½ æ˜¯å¾éŠæˆ²å®Œæˆç•«é¢è·³éä¾†ï¼Œæœ¬é æœƒè‡ªå‹•æŠŠåˆ†æ•¸å¯«å…¥æ’è¡Œæ¦œã€‚ä¹Ÿå¯æ‰‹å‹•æ–°å¢ã€‚
        </div>

        <div style="margin-top:12px">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1;min-width:180px">
              <div class="tiny muted">ç©å®¶æš±ç¨±</div>
              <input id="nameInput" placeholder="ä¾‹å¦‚ï¼šé˜¿é‡‘ / KinmenHero" />
            </div>
            <div style="width:140px">
              <div class="tiny muted">éŠæˆ²</div>
              <select id="gameSelect">
                <option value="riddle">ğŸ§© å³æ™‚è§£è¬</option>
                <option value="stamp">ğŸ§¾ é›†ç« ä»»å‹™</option>
                <option value="shoot">ğŸ¯ æ™¯é»å°„æ“Š</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;align-items:flex-end">
            <div style="width:140px">
              <div class="tiny muted">åˆ†æ•¸</div>
              <input id="scoreInput" inputmode="numeric" placeholder="0" />
            </div>
            <div style="width:140px">
              <div class="tiny muted">æ™‚é–“ï¼ˆç§’ï¼‰</div>
              <input id="timeInput" inputmode="numeric" placeholder="0" />
            </div>
            <div style="flex:1;min-width:180px">
              <div class="tiny muted">ç«™é»/å‚™è¨»ï¼ˆå¯ç©ºï¼‰</div>
              <input id="noteInput" placeholder="ä¾‹å¦‚ï¼šA10 / é‡‘åŸè»Šç«™ / Aç·šå®Œæˆ" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;justify-content:flex-start">
            <button class="btn good" id="addBtn">â• æ–°å¢/é€å‡ºæˆç¸¾</button>
            <button class="btn secondary" id="clearParamBtn">ğŸ§¹ æ¸…æ‰ç¶²å€åƒæ•¸</button>
          </div>

          <div class="tiny muted" style="margin-top:10px">
            ä½ ä¹Ÿå¯ä»¥å¾éŠæˆ²ç”¨é€™ç¨®æ–¹å¼è·³è½‰ï¼š<span class="k">?game=riddle&name=Peter&score=120&time=95&stop=A10</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <h2>â‘¡ æ’è¡Œæ¦œè¨­å®š</h2>
        <div class="tiny muted" style="margin-top:8px">æ’åºè¦å‰‡ï¼š<b>åˆ†æ•¸é«˜å„ªå…ˆ</b>ï¼Œåˆ†æ•¸ç›¸åŒå‰‡ <b>æ™‚é–“çŸ­å„ªå…ˆ</b>ã€‚</div>

        <div style="margin-top:12px">
          <div class="tiny muted">æŸ¥çœ‹éŠæˆ²</div>
          <select id="filterSelect" style="margin-top:6px">
            <option value="all">å…¨éƒ¨éŠæˆ²</option>
            <option value="riddle">ğŸ§© å³æ™‚è§£è¬</option>
            <option value="stamp">ğŸ§¾ é›†ç« ä»»å‹™</option>
            <option value="shoot">ğŸ¯ æ™¯é»å°„æ“Š</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <div class="tiny muted">åªçœ‹æœ€è¿‘å¹¾å¤©</div>
          <select id="daysSelect" style="margin-top:6px">
            <option value="9999">ä¸é™åˆ¶</option>
            <option value="7">è¿‘ 7 å¤©</option>
            <option value="30">è¿‘ 30 å¤©</option>
          </select>
        </div>

        <div class="row" style="margin-top:12px;justify-content:flex-start">
          <button class="btn warn" id="wipeBtn">ğŸ—‘ï¸ æ¸…ç©ºæ’è¡Œæ¦œï¼ˆæ­¤è£ç½®ï¼‰</button>
        </div>

        <div class="tiny muted" style="margin-top:10px">
          âš ï¸ ç›®å‰æ˜¯ã€Œæ¯å°æ‰‹æ©Ÿè‡ªå·±ä¸€ä»½æ¦œã€ã€‚è‹¥ä½ è¦ã€Œå¤§å®¶å…±ç”¨åŒä¸€æ¦œã€ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥æ”¹æˆ Google Sheet / Firebaseã€‚
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <h2>â‘¢ æ’è¡Œæ¦œ</h2>
        <div class="pill" id="countPill">â€”</div>
      </div>

      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:64px">åæ¬¡</th>
              <th>ç©å®¶</th>
              <th style="width:140px">éŠæˆ²</th>
              <th class="right" style="width:110px">åˆ†æ•¸</th>
              <th class="right" style="width:110px">æ™‚é–“</th>
              <th>ç«™é»/å‚™è¨»</th>
              <th style="width:170px">æ™‚é–“æˆ³</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted">å°šç„¡æˆç¸¾ã€‚å»ç©ä¸€å±€å†å›ä¾†å§ï¼</td></tr>
          </tbody>
        </table>
      </div>

      <div class="tiny muted" style="margin-top:10px">
        å°æŠ€å·§ï¼šä½ å¯ä»¥åœ¨ TM é¦–é åšä¸€å€‹ã€Œæ’è¡Œæ¦œã€æŒ‰éˆ•ï¼Œå°å‘æœ¬é ã€‚
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  var PORTAL_URL = "https://thtsai820-cpu.github.io/TM/";
  var KEY = "tm_leaderboard_v1";

  function $(id){ return document.getElementById(id); }
  function nowISO(){ return new Date().toISOString(); }
  function safeNum(v){
    var n = parseInt(String(v||"").replace(/[^\d]/g,""), 10);
    return isNaN(n) ? 0 : n;
  }
  function safeText(v, maxLen){
    var s = String(v||"").trim();
    if(maxLen && s.length > maxLen) s = s.slice(0, maxLen);
    return s;
  }
  function gameLabel(game){
    if(game==="riddle") return "ğŸ§© å³æ™‚è§£è¬";
    if(game==="stamp") return "ğŸ§¾ é›†ç« ä»»å‹™";
    if(game==="shoot") return "ğŸ¯ æ™¯é»å°„æ“Š";
    return game || "-";
  }
  function toast(msg){
    var t = $("toast");
    if(!t) return;
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._timer);
    toast._timer = setTimeout(function(){ t.style.display = "none"; }, 2200);
  }

  function load(){
    try{
      var raw = localStorage.getItem(KEY);
      var arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) arr = [];
      return arr;
    }catch(e){
      return [];
    }
  }
  function save(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function upsertEntry(entry){
    var arr = load();
    arr.push(entry);
    save(arr);
  }

  function getParams(){
    var p = new URLSearchParams(location.search);
    return {
      game: safeText(p.get("game") || "", 20),
      name: safeText(p.get("name") || "", 20),
      score: safeNum(p.get("score")),
      time: safeNum(p.get("time")),
      stop: safeText(p.get("stop") || "", 30),
      note: safeText(p.get("note") || "", 60)
    };
  }

  function clearQuery(){
    var url = location.origin + location.pathname;
    history.replaceState({}, "", url);
  }

  function sameSubmissionKey(params){
    // ç”¨é€™å€‹ key ä¾†é¿å…ã€ŒåŒä¸€é é‡æ•´å°±ä¸€ç›´å…¥æ¦œã€
    return [
      params.game, params.name, params.score, params.time,
      params.stop || params.note || ""
    ].join("|");
  }

  function maybeAutoAddFromParams(){
    var params = getParams();
    if(!params.game || !params.score) return;

    // é˜²æ­¢é‡æ•´é‡è¤‡æ–°å¢
    var submitKey = sameSubmissionKey(params);
    try{
      var lastKey = sessionStorage.getItem("tm_last_submit_key");
      if(lastKey === submitKey) return;
      sessionStorage.setItem("tm_last_submit_key", submitKey);
    }catch(e){}

    var entry = {
      id: "e_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
      game: params.game || "riddle",
      name: params.name || "ç©å®¶",
      score: params.score,
      time: params.time || 0,
      note: (params.stop ? ("ç«™é»ï¼š" + params.stop) : "") + (params.note ? ("ï½œ" + params.note) : ""),
      ts: nowISO()
    };
    upsertEntry(entry);
    toast("å·²å¯«å…¥æ’è¡Œæ¦œï¼š " + entry.name + " / " + gameLabel(entry.game));
  }

  function filteredSorted(){
    var arr = load();
    var filter = $("filterSelect").value;
    var days = parseInt($("daysSelect").value, 10);

    if(filter !== "all"){
      arr = arr.filter(function(x){ return x && x.game === filter; });
    }
    if(days && days !== 9999){
      var cutoff = Date.now() - days*24*60*60*1000;
      arr = arr.filter(function(x){
        var t = Date.parse(x.ts || "");
        return !isNaN(t) && t >= cutoff;
      });
    }

    // æ’åºï¼šåˆ†æ•¸ DESC, æ™‚é–“ ASC, æ™‚é–“æˆ³ DESC
    arr.sort(function(a,b){
      var s = (b.score||0) - (a.score||0);
      if(s !== 0) return s;
      var t = (a.time||0) - (b.time||0);
      if(t !== 0) return t;
      return Date.parse(b.ts||"") - Date.parse(a.ts||"");
    });

    return arr;
  }

  function render(){
    var arr = filteredSorted();
    $("countPill").textContent = "å…± " + arr.length + " ç­†";
    var tb = $("tbody");
    if(!arr.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">å°šç„¡æˆç¸¾ã€‚å»ç©ä¸€å±€å†å›ä¾†å§ï¼</td></tr>';
      return;
    }

    var html = "";
    for(var i=0;i<Math.min(arr.length, 100);i++){
      var x = arr[i] || {};
      html += "<tr>" +
        "<td class='rank'>" + (i+1) + "</td>" +
        "<td>" + escapeHtml(x.name||"ç©å®¶") + "</td>" +
        "<td>" + escapeHtml(gameLabel(x.game)) + "</td>" +
        "<td class='right goodTxt'>" + (x.score||0) + "</td>" +
        "<td class='right'>" + (x.time||0) + "s</td>" +
        "<td>" + escapeHtml(x.note||"-") + "</td>" +
        "<td class='tiny muted'>" + escapeHtml(x.ts||"-") + "</td>" +
      "</tr>";
    }
    tb.innerHTML = html;
  }

  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  // --- bind UI ---
  $("backBtn").onclick = function(){ location.href = PORTAL_URL + "?v=" + Date.now(); };
  $("copyLinkBtn").onclick = function(){
    var url = location.href;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(url).then(function(){ toast("å·²è¤‡è£½é€£çµ"); }).catch(function(){ toast(url); });
    }else{
      toast(url);
      prompt("è¤‡è£½é€£çµï¼š", url);
    }
  };

  $("clearParamBtn").onclick = function(){
    clearQuery();
    toast("å·²æ¸…æ‰ç¶²å€åƒæ•¸");
  };

  $("addBtn").onclick = function(){
    var entry = {
      id: "e_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
      game: $("gameSelect").value || "riddle",
      name: safeText($("nameInput").value || "ç©å®¶", 20) || "ç©å®¶",
      score: safeNum($("scoreInput").value),
      time: safeNum($("timeInput").value),
      note: safeText($("noteInput").value, 60),
      ts: nowISO()
    };
    if(!entry.score){
      toast("è«‹è‡³å°‘å¡«åˆ†æ•¸ï¼ˆscoreï¼‰");
      return;
    }
    upsertEntry(entry);
    toast("å·²æ–°å¢æˆç¸¾");
    render();
  };

  $("wipeBtn").onclick = function(){
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ­¤è£ç½®çš„æ’è¡Œæ¦œå—ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")){
      localStorage.removeItem(KEY);
      toast("å·²æ¸…ç©ºæ’è¡Œæ¦œ");
      render();
    }
  };

  $("filterSelect").onchange = render;
  $("daysSelect").onchange = render;

  // --- init: å…ˆå¾åƒæ•¸è‡ªå‹•å¯«å…¥ï¼Œå†å¸¶å…¥è¡¨å–® ---
  var params = getParams();
  if(params.name) $("nameInput").value = params.name;
  if(params.game) $("gameSelect").value = params.game;
  if(params.score) $("scoreInput").value = String(params.score);
  if(params.time) $("timeInput").value = String(params.time);
  if(params.stop || params.note){
    $("noteInput").value = (params.stop ? ("ç«™é»ï¼š" + params.stop) : "") + (params.note ? ("ï½œ" + params.note) : "");
  }

  maybeAutoAddFromParams();
  render();
})();
</script>
</body>
</html>
