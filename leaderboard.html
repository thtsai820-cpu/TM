<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ’è¡Œæ¦œï½œç©éŠæˆ²æ­å¥½è¡Œ</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
    body{margin:0;background:#0b0c10;color:#fff}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#141622;border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 10px 28px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;opacity:.95}
    h1{font-size:22px;margin:6px 0 0}
    h2{font-size:16px;margin:0}
    .sub{opacity:.86;font-size:13px;line-height:1.65;margin-top:8px}
    .tiny{font-size:12px;opacity:.82;line-height:1.6}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#1d2140;color:#fff;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.secondary{background:transparent}
    .btn.warn{background:#40211d}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1120;color:#fff;font-size:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;text-align:left;font-size:13px}
    th{opacity:.9}
    .muted{opacity:.72}
    @media(max-width:760px){.grid2{grid-template-columns:1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div class="pill">ğŸ† æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿç‰ˆï¼‰</div>
        <h1>ç©éŠæˆ²æ­å¥½è¡Œï½œæ’è¡Œæ¦œ</h1>
        <div class="sub">æ­¤æ’è¡Œæ¦œå­˜æ–¼ä½ çš„è£ç½®ï¼ˆlocalStorageï¼‰ã€‚ä¹‹å¾Œå¯å‡ç´šæˆé›²ç«¯ç‰ˆã€‚</div>
      </div>
      <div class="row" style="justify-content:flex-start">
        <button class="btn secondary" onclick="goPortal()">â¬… å› TM å¹³å°</button>
        <button class="btn" onclick="openFromQuery()">ğŸ“¥ è®€å–ç¶²å€æˆç¸¾</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2>æ–°å¢æˆç¸¾</h2>
      <span class="pill">å¯æ‰‹å‹•è¼¸å…¥ï¼æˆ–ç”±éŠæˆ²è‡ªå‹•å¸¶å…¥</span>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="tiny muted">éŠæˆ²</div>
        <select id="gameKey">
          <option value="riddle">ğŸ§© å³æ™‚è§£è¬</option>
          <option value="stamp">ğŸ§¾ é›†ç« ä»»å‹™</option>
          <option value="shoot">ğŸ¯ æ™¯é»å°„æ“Š</option>
        </select>
      </div>
      <div>
        <div class="tiny muted">ç«™é»ï¼ˆå¯ç©ºç™½ï¼‰</div>
        <input id="stopId" placeholder="ä¾‹å¦‚ A03" />
      </div>
      <div>
        <div class="tiny muted">æš±ç¨±</div>
        <input id="player" placeholder="ä¾‹å¦‚ å°é‡‘é–€ç©å®¶" maxlength="16" />
      </div>
      <div>
        <div class="tiny muted">åˆ†æ•¸</div>
        <input id="score" type="number" placeholder="ä¾‹å¦‚ 1200ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰" />
      </div>
      <div>
        <div class="tiny muted">æ™‚é–“ï¼ˆç§’ï¼‰</div>
        <input id="timeSec" type="number" placeholder="ä¾‹å¦‚ 83ï¼ˆè¶Šå°è¶Šå¥½ï¼‰" />
      </div>
      <div>
        <div class="tiny muted">å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰</div>
        <input id="note" placeholder="ä¾‹å¦‚ Aç·šæŒ‘æˆ°" maxlength="28" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-start">
      <button class="btn" onclick="addScoreFromForm()">â• é€å‡ºæˆç¸¾</button>
      <button class="btn secondary" onclick="fillDemo()">ğŸ§ª å¡«å…¥ç¤ºç¯„</button>
    </div>

    <div class="notice tiny muted" style="margin-top:10px;border:1px dashed rgba(255,255,255,.18);border-radius:14px;padding:10px;background:rgba(255,255,255,.04)">
      âœ… éŠæˆ²å¯ç”¨ç¶²å€å¸¶å…¥ï¼š<span class="mono">leaderboard.html?game=riddle&name=Peter&score=1200&time=83&stop=A03</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2>æŸ¥çœ‹æ’è¡Œæ¦œ</h2>
      <div class="row" style="justify-content:flex-start">
        <span class="tiny muted">æ’åºä¾æ“šï¼š</span>
        <select id="metric" onchange="render()">
          <option value="time">â± ä»¥æ™‚é–“ï¼ˆè¶Šå°è¶Šå¥½ï¼‰</option>
          <option value="score">â­ ä»¥åˆ†æ•¸ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰</option>
        </select>
        <span class="tiny muted">é¡¯ç¤ºéŠæˆ²ï¼š</span>
        <select id="filterGame" onchange="render()">
          <option value="all">å…¨éƒ¨</option>
          <option value="riddle">ğŸ§© å³æ™‚è§£è¬</option>
          <option value="stamp">ğŸ§¾ é›†ç« ä»»å‹™</option>
          <option value="shoot">ğŸ¯ æ™¯é»å°„æ“Š</option>
        </select>
      </div>
    </div>

    <div id="tableWrap"></div>

    <div class="row" style="margin-top:10px;justify-content:flex-start">
      <button class="btn secondary" onclick="exportJSON()">ğŸ“¤ åŒ¯å‡ºJSON</button>
      <button class="btn warn" onclick="clearAll()">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨</button>
    </div>
  </div>
</div>

<script>
  const PORTAL_URL = "https://thtsai820-cpu.github.io/TM/";
  const KEY = "tm_leaderboard_v1";

  function goPortal(){ location.href = PORTAL_URL + "?v=" + Date.now(); }

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch(e){ return []; }
  }
  function save(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  // çµ¦éŠæˆ²å‘¼å«ï¼šsubmitScore({gameKey, player, score, timeSec, stopId, note})
  function submitScore(entry){
    const now = new Date().toISOString();
    const e = {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      ts: now,
      gameKey: (entry.gameKey || "riddle"),
      player: (entry.player || "ç©å®¶").trim().slice(0,16),
      stopId: (entry.stopId || "").trim().toUpperCase().slice(0,8),
      score: isFinite(+entry.score) ? +entry.score : null,
      timeSec: isFinite(+entry.timeSec) ? +entry.timeSec : null,
      note: (entry.note || "").trim().slice(0,28)
    };
    const arr = load();
    arr.push(e);
    save(arr);
    render();
    return e;
  }

  // å¾è¡¨å–®æ–°å¢
  function addScoreFromForm(){
    submitScore({
      gameKey: document.getElementById("gameKey").value,
      player: document.getElementById("player").value,
      score: document.getElementById("score").value,
      timeSec: document.getElementById("timeSec").value,
      stopId: document.getElementById("stopId").value,
      note: document.getElementById("note").value
    });
    alert("å·²é€å‡ºæˆç¸¾ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼‰");
  }

  // å¾ç¶²å€è®€å–ï¼ˆè®“éŠæˆ²è·³è½‰éä¾†å¯è‡ªå‹•å¡«ï¼‰
  function openFromQuery(){
    const p = new URLSearchParams(location.search);
    const game = p.get("game");
    const name = p.get("name");
    const score = p.get("score");
    const time = p.get("time");
    const stop = p.get("stop");
    const note = p.get("note");

    if(game) document.getElementById("gameKey").value = game;
    if(stop) document.getElementById("stopId").value = stop;
    if(name) document.getElementById("player").value = name;
    if(score) document.getElementById("score").value = score;
    if(time) document.getElementById("timeSec").value = time;
    if(note) document.getElementById("note").value = note;

    // å¦‚æœæœ‰ name ä¸” (score æˆ– time) å°±è‡ªå‹•å…¥æ¦œ
    if(name && (score || time)){
      submitScore({gameKey: game, player: name, score, timeSec: time, stopId: stop, note});
      // æ¸…æ‰ queryï¼Œé¿å…é‡æ•´é‡è¤‡å…¥æ¦œ
      history.replaceState({}, "", location.pathname);
      alert("å·²å¾ç¶²å€æˆç¸¾åŠ å…¥æ’è¡Œæ¦œ");
    }else{
      alert("å·²è®€å–ç¶²å€åƒæ•¸åˆ°è¡¨å–®ï¼ˆè‹¥è¦è‡ªå‹•å…¥æ¦œï¼Œéœ€å¸¶ name ä¸” score/timeï¼‰");
    }
  }

  function fillDemo(){
    document.getElementById("gameKey").value = "riddle";
    document.getElementById("stopId").value = "A03";
    document.getElementById("player").value = "å°é‡‘é–€ç©å®¶";
    document.getElementById("score").value = 1200;
    document.getElementById("timeSec").value = 83;
    document.getElementById("note").value = "Aç·šç¤ºç¯„";
  }

  function labelGame(k){
    return k==="riddle" ? "ğŸ§© å³æ™‚è§£è¬" : k==="stamp" ? "ğŸ§¾ é›†ç« " : "ğŸ¯ å°„æ“Š";
  }

  function render(){
    const metric = document.getElementById("metric").value; // time or score
    const filter = document.getElementById("filterGame").value;

    let arr = load();
    if(filter !== "all") arr = arr.filter(x=>x.gameKey===filter);

    // æ’åºï¼štime è¶Šå°è¶Šå‰ï¼›score è¶Šå¤§è¶Šå‰
    arr.sort((a,b)=>{
      if(metric==="time"){
        const at = (a.timeSec ?? Number.POSITIVE_INFINITY);
        const bt = (b.timeSec ?? Number.POSITIVE_INFINITY);
        if(at!==bt) return at-bt;
        const as = (b.score ?? -1) - (a.score ?? -1);
        if(as!==0) return as;
        return (b.ts||"").localeCompare(a.ts||"");
      }else{
        const as = (b.score ?? -1) - (a.score ?? -1);
        if(as!==0) return as;
        const at = (a.timeSec ?? Number.POSITIVE_INFINITY) - (b.timeSec ?? Number.POSITIVE_INFINITY);
        if(at!==0) return at;
        return (b.ts||"").localeCompare(a.ts||"");
      }
    });

    // åªé¡¯ç¤ºå‰ 50
    arr = arr.slice(0,50);

    const rows = arr.map((x,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${labelGame(x.gameKey)}</td>
        <td>${escapeHtml(x.player)}</td>
        <td>${x.stopId ? escapeHtml(x.stopId) : '<span class="muted">â€”</span>'}</td>
        <td>${x.score ?? '<span class="muted">â€”</span>'}</td>
        <td>${x.timeSec ?? '<span class="muted">â€”</span>'}</td>
        <td class="muted">${new Date(x.ts).toLocaleString()}</td>
        <td class="muted">${x.note ? escapeHtml(x.note) : 'â€”'}</td>
      </tr>
    `).join("");

    document.getElementById("tableWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th><th>éŠæˆ²</th><th>æš±ç¨±</th><th>ç«™é»</th><th>åˆ†æ•¸</th><th>æ™‚é–“(ç§’)</th><th>æ™‚é–“</th><th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="8" class="muted">å°šç„¡æˆç¸¾ã€‚ä½ å¯ä»¥å…ˆæŒ‰ã€Œå¡«å…¥ç¤ºç¯„ã€â†’ã€Œé€å‡ºæˆç¸¾ã€ã€‚</td></tr>`}
        </tbody>
      </table>
      <div class="tiny muted" style="margin-top:8px">â€» æœ¬æ©Ÿç‰ˆï¼šä¸åŒæ‰‹æ©Ÿ/ç€è¦½å™¨ä¸å…±äº«è³‡æ–™ã€‚æœªä¾†å¯å‡ç´šé›²ç«¯æ’è¡Œæ¦œã€‚</div>
    `;
  }

  function exportJSON(){
    const data = localStorage.getItem(KEY) || "[]";
    // ç›´æ¥å½ˆå‡ºè®“ä½ è¤‡è£½
    const w = window.open("", "_blank");
    w.document.write(`<pre style="white-space:pre-wrap;word-break:break-word">${escapeHtml(data)}</pre>`);
    w.document.close();
  }

  function clearAll(){
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨æ’è¡Œæ¦œè³‡æ–™ï¼Ÿï¼ˆåªæœƒæ¸…ä½ é€™å°è£ç½®ï¼‰")){
      localStorage.removeItem(KEY);
      render();
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  // åˆå§‹æ¸²æŸ“
  render();
</script>
</body>
</html>
